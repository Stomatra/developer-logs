# 尝试在C#项目中导入py记录

---

## 在Nuget安装Pythonnet
解决Nuget程序包中“找不到包”的问题
在“项目”栏下“管理Nuget程序包”中添加程序包源https://api.nuget.org/v3/index.json，并勾选
接下来搜索Pythonnet即可找到，并安装即可，之后在头部使用using Python.Runtime即可。

---

## 导入py文件
示例文件：
```Cs
using Python.Runtime;

public class PythonExecuter
{
   private readonly string _pythonDllPath;
   private readonly string _workDir;
   public PythonExecuter(string dllPath, string workDir)
   {
       _pythonDllPath = dllPath;
       _workDir = workDir;
   }
   public async Task<bool> ExecutePythonScript(string scriptName)
   {
       bool result = false;
       Runtime.PythonDLL = _pythonDllPath;
       PythonEngine.Initialize();
       dynamic sys = Py.Import("sys");
       sys.path.append(_workDir);
       PythonEngine.BeginAllowThreads();
       await Task.Run(() =>
       {
           try
           {
               using (Py.GIL())
               {
                   dynamic script = Py.Import(scriptName);
                   dynamic output = script.main();
                   Console.WriteLine($"Python 脚本执行成功，返回值：{output}");
                   result = (int)output == 0;
               }
           }
           catch (Exception ex)
           {
               Console.WriteLine($"执行失败：{ex}");
           }
       });
       PythonEngine.Shutdown();
       return result;
   }
}
```
接下来是`main`
```Cs
private static async Task Main(string[] args)
{
    string pythonDllPath = @"..\python\python313.dll";//这两部分是绝对路径
    string workDir = @"..\PythonExecuter";

    var executer = new PythonExecuter(pythonDllPath, workDir);
    var result = await executer.ExecutePythonScript("task13.py");
    Console.WriteLine($"Python 脚本执行结果：{result}");
    Console.WriteLine(result);
}
```

---

### 解决架构问题
报错信息：
System.TypeInitializationException:““Delegates”的类型初始值设定项引发异常。”
1.DllNotFoundException: Could not load ../Python/python313.dll.
2.Win32Exception: %1 不是有效的 Win32 应用程序。
这里需要取消掉默认的“首选x32”，把目标平台改成x64
详见（感谢这位大佬提供的解决方案）：https://www.bilibili.com/opus/964422245019549702

---

### 目前无法解决的
即使文件夹中已经放入了整个的py都复制过去了，仍然提示找不到dll文件：
System.TypeInitializationException:““Delegates”的类型初始值设定项引发异常。”
MissingMethodException: Failed to load symbol _PyThreadState_UncheckedGet.
Win32Exception: 找不到指定的程序。
目前没有找到解决方案，因为还在上学，没有时间去细致捣鼓这些东西，所以打算把这个先扔在一边了。
